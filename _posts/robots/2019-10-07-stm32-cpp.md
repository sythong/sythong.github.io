---
layout: post
title: Hướng dẫn lập trình STM32 điều khiển động cơ sử dụng CubeMX
author: Thong Ho
date: '2019-10-10 08:55:23 +0530'
categories: Ros-and-Robot
summary: Hướng dẫn lập trình stm32
thumbnail: kalman2.png
permalink: /:categories/stm32-motor-controller-cubemx
use_math: true
---


## Cấu hình STM32 với PWM.
- Cách tiện dụng và đơn giản nhất cho việc lập trình là sử dụng CUBEMX để cấu hình cho stm32


## STM32 Basic timer với interrupt và PWM mode
Nguồn tham khảo từ [here](http://www.emcu.eu/stm32-basic-timer/)

### Giới thiệu 
![timer of STM32](/assets/img/robots/stm32/timer.png)

- Công thức tính
$UEV = TIM_{CLK} / ((prescaler + 1) \times (ARR + 1) \times (RCR + 1))$$
where : 
    - $TIM_{CLK} :  là clock cung cấp cho timer
    - $ prescaler$ : là thanh gi 16 bits là bộ chia cho timer. có thể chia từ 1 đến 65535
    - $ ARR $ -auto-reload register : là giá trị đếm của timer , 16 bis hoặc 32 bits; đây là giá trị counter period trong cubeMX
    - $ RCR $ -Repetiton counter register): Giá trị đếm lặp lại 16bits.

    - Ví dụ: 
        - $TIM_{CLK}$=72Mhz
        - $prescaler$=1, 
        - $ARR$ = 655635, 
        - $RCR$ = 0
    
        - $UEV$ = 549.3 Hz 

- Cấu hình timer trên CubeMX cần chú ý các tham số :
    - $prescaler$ 
    - counter period $ARR$
    - enable Timer global interrupt
- Cấu hình như trong hình :
    ![Clock cofiguration](/assets/img/robots/stm32/clock_timer.jpg)
    ![timer 4 config](/assets/img/robots/stm32/timer4.jpg)

- Công thức tính thời gian
```
T = (1/APB_TIM_CLK in MHz) * (PRESCALER_Value + 1) * (PERIOD_Value + 1)
```

    - ví dụ : 
        - suppose:
        - APB_TIM_CLK = 8MHz
        - PRESCALER_Value = 999
        - PERIOD_Value = 7999
        - the formula is:
        
        - T= (1/8*10^6) * (999+1) * (7999+1) = 1s
        
- Giá trị được cấu hình có thể hiểu như hình :
    ![timer 14 config](/assets/img/robots/stm32/timer14.png)


- Generate code và tiến hành lập trình trên keilC
    ![generate code](/assets/img/robots/stm32/gencode.jpg)


## Lập trình trên keilC
- Lưu ý khi generate ra code thì trong hàm main. những khu vực được comments là BEGIN ...USER thì sẽ được giữ lại, còn khi lập trình bên ngoài. nếu update gen lại từ cubemx thì sẽ bị xóa đi. 

- Viết function cho cài đặt giá trị pwm. Giả sử m cầu hình cho pwm của timer 4 , channel 1. 

```cpp
/* USER CODE BEGIN 4 */
void user_pwm_setvalue(uint16_t value)
{
    TIM_OC_InitTypeDef sConfigOC;
  
    sConfigOC.OCMode = TIM_OCMODE_PWM1;
    sConfigOC.Pulse = value;
    sConfigOC.OCPolarity = TIM_OCPOLARITY_HIGH;
    sConfigOC.OCFastMode = TIM_OCFAST_DISABLE;
    HAL_TIM_PWM_ConfigChannel(&htim4, &sConfigOC, TIM_CHANNEL_1);
    HAL_TIM_PWM_Start(&htim4, TIM_CHANNEL_1);  
}
/* USER CODE END 4 */
```


# Hướng dẫn đọc encoder từ stm32 dùng CUBEMX


# Hướng dẫn sử dụng với UART 
## Cấu hình uart :

![generate code](/assets/img/robots/stm32/configure_uart.jpg) 

- Viết các hàm truyền chuỗi từ STM32
    - Nhớ include thư viện "string.h" tại mục include cho user nếu không 2 functions dưới sẽ báo lỗi phần độ dài chuỗi.

```
#include "string.h" 

/* USER CODE BEGIN 4 */
    
void debugPrint(UART_HandleTypeDef *huart, char _out[])
{
    HAL_UART_Transmit(huart, (uint8_t *) _out, strlen(_out), 10);
} 

void debugPrintln(UART_HandleTypeDef *huart, char _out[])
{
    HAL_UART_Transmit(huart, (uint8_t *) _out, strlen(_out), 10);
    char newline[3] = "\r\n";
    HAL_UART_Transmit(huart, (uint8_t *) newline, 2, 10);
} 
/* USER CODE END 4 */
```


